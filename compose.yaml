services:
    proxy:
        image: traefik:v3.4
        command: --providers.docker
        ports:
            - 80:80
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock

    bot:
        build:
            context: ./
            target: bot-final
        image: ezlixp/ogybot2:latest
        restart: on-failure:5
        depends_on:
            backend:
                condition: service_healthy

    backend:
        build:
            context: ./
            target: backend-final
        image: ezlixp/ico-server:latest
        restart: on-failure:5
        ports:
            - 3000:3000
        healthcheck:
            test:
                [
                    "CMD",
                    "node",
                    "-e",
                    "require('http').get('http://localhost:3000/healthz', res => res.statusCode === 200 ? process.exit(0) : process.exit(1)).on('error', () => process.exit(1))",
                ]
            interval: 10s
            timeout: 3s
            retries: 5
            start_period: 10s
        labels:
            traefik.http.routers.backend.rule: Host(`${HOST_IP}`)
            traefik.http.services.backend.loadbalancer.server.port: 3000

